<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BirgyFest - Control de Acceso</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script> <!-- Librería para escanear QR -->
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .title-font { font-family: 'Bebas Neue', cursive; }
        #reader { width: 100%; max-width: 400px; border-radius: 1rem; overflow: hidden; }
        .neon-green { text-shadow: 0 0 8px #10b981, 0 0 15px #059669; color: #6ee7b7; }
        .neon-red { text-shadow: 0 0 8px #ef4444, 0 0 15px #dc2626; color: #fca5a5; }
        .neon-yellow { text-shadow: 0 0 8px #facc15, 0 0 15px #d97706; color: #fde047; }
        
        /* Estilos específicos del estado */
        #status-display {
            display: none;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            animation: pulse 1s infinite alternate;
        }
        .verified { background-color: #10b981; border: 4px solid #047857; }
        .not-verified { background-color: #ef4444; border: 4px solid #b91c1c; }
        .loading { background-color: #374151; border: 4px solid #1f2937; }

        @keyframes pulse {
            from { transform: scale(1.0); }
            to { transform: scale(1.02); }
        }
    </style>
</head>
<body class="text-white">

    <div class="w-full max-w-sm mx-auto flex flex-col items-center">
        
        <header class="text-center mb-6">
            <h1 class="title-font text-5xl font-black neon-yellow">
                CONTROL DE ACCESO
            </h1>
            <p class="text-sm text-gray-400 mt-1">
                Apunta el QR del invitado a la cámara
            </p>
        </header>

        <!-- Contenedor del Escáner QR -->
        <div id="reader" class="mb-6"></div>

        <!-- Pantalla de Estado (Verificado / No Verificado) -->
        <div id="status-display" class="w-full text-center">
            <p id="guest-name-display" class="text-xl font-bold mb-1"></p>
            <p id="verification-status-text" class="title-font text-3xl font-black"></p>
        </div>
        
        <!-- Botón para detener/reiniciar el escáner -->
        <button id="restart-button" 
                class="mt-4 w-full title-font font-black py-3 px-6 rounded-xl text-xl uppercase tracking-wider transition duration-300 bg-gray-600 hover:bg-gray-700 active:scale-95">
            Reiniciar Escáner
        </button>
        
        <!-- Mensaje de error/instrucción -->
        <p id="error-message" class="text-red-400 mt-4 text-center hidden">
            Asegúrate de haber implementado y desplegado el API de Google Apps Script.
        </p>

    </div>

    <script>
        // --- CONFIGURACIÓN CRÍTICA ---
        // DEBES REEMPLAZAR ESTA URL con la URL de tu API de Google Apps Script DESPUÉS de seguir la guía.
        const VERIFIER_API_URL = 'https://script.google.com/macros/s/AKfycbxlks1b_7ZULR3rUZH6h9smgFwmshZ_CxtBuozPrFRobR5guPWr5bjbLZ2CjWIAv1pP5w/exec'; 
        // -----------------------------

        const readerDiv = 'reader';
        const statusDisplay = document.getElementById('status-display');
        const guestNameDisplay = document.getElementById('guest-name-display');
        const verificationStatusText = document.getElementById('verification-status-text');
        const restartButton = document.getElementById('restart-button');
        const errorMessage = document.getElementById('error-message');
        let html5QrcodeScanner = null;
        let isScanning = false;

        // Función para mostrar el estado de verificación
        function setStatus(status, name, message) {
            statusDisplay.style.display = 'block';
            statusDisplay.className = 'w-full text-center ' + status;
            guestNameDisplay.textContent = name;
            verificationStatusText.textContent = message;
            
            // Ocultar el estado automáticamente después de 5 segundos
            setTimeout(() => {
                statusDisplay.style.display = 'none';
            }, 5000);
        }

        // Función de verificación que llama al API de GAS
        async function checkGuest(guestName) {
            if (VERIFIER_API_URL === 'YOUR_DEPLOYED_WEB_APP_URL') {
                setStatus('not-verified', guestName.toUpperCase(), 'ERROR DE CONFIGURACIÓN');
                errorMessage.classList.remove('hidden');
                return;
            }

            // 1. Mostrar estado de carga
            setStatus('loading', guestName.toUpperCase(), 'VERIFICANDO...');

            try {
                // El API espera el nombre del invitado en el parámetro 'guest'
                const url = `${VERIFIER_API_URL}?guest=${encodeURIComponent(guestName)}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();

                if (result.isVerified) {
                    setStatus('verified', guestName.toUpperCase(), '✅ INVITADO VERIFICADO');
                } else {
                    setStatus('not-verified', guestName.toUpperCase(), '❌ INVITADO NO VERIFICADO');
                }

            } catch (error) {
                console.error('Error al llamar al API de verificación:', error);
                setStatus('not-verified', guestName.toUpperCase(), 'ERROR DE CONEXIÓN API');
            }
            
            // 2. Reanudar el escáner automáticamente para el siguiente QR
            if (html5QrcodeScanner && isScanning === false) {
                 // Pequeño retraso para permitir la visualización del estado
                setTimeout(() => {
                    html5QrcodeScanner.resume();
                    isScanning = true;
                    statusDisplay.style.display = 'none'; // Ocultar el estado si se reanuda la cámara
                }, 1000); 
            }
        }

        // Función que se ejecuta cuando se escanea un QR
        function onScanSuccess(decodedText, decodedResult) {
            // Detener el escáner inmediatamente
            html5QrcodeScanner.pause(); 
            isScanning = false;

            console.log(`QR Code detectado: ${decodedText}`, decodedResult);

            // 1. Intentar parsear el URL para extraer el nombre del invitado
            try {
                const url = new URL(decodedText);
                const guestName = url.searchParams.get('guest'); // Esperamos el parámetro 'guest'
                
                if (guestName) {
                    checkGuest(guestName);
                } else {
                    setStatus('not-verified', 'QR Inválido', 'NO SE ENCONTRÓ EL NOMBRE (Parámetro "guest" faltante)');
                    html5QrcodeScanner.resume(); // Continuar escaneando si es un QR inesperado
                }
            } catch (e) {
                // Si el texto decodificado no es un URL válido o no tiene el formato esperado
                setStatus('not-verified', 'QR Inválido', 'FORMATO DE QR INCORRECTO (Debe ser un URL)');
                html5QrcodeScanner.resume(); // Continuar escaneando
            }
        }

        function onScanFailure(error) {
            // console.warn(`Error de escaneo: ${error}`);
        }

        function startScanner() {
            // Verificar si el escáner ya está activo para evitar duplicados
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => {
                    console.error("Fallo al detener el escáner anterior:", error);
                });
            }

            html5QrcodeScanner = new Html5QrcodeScanner(
                readerDiv, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                false // Disable verbose logging
            );
            
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            isScanning = true;
            statusDisplay.style.display = 'none';
            errorMessage.classList.add('hidden');
        }

        restartButton.addEventListener('click', startScanner);

        // Inicia el escáner al cargar la página
        window.onload = startScanner;
    </script>

</body>
</html>