<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCANNER - BirgyFest Security</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería moderna para QR -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'birgyfest'; 
        const firebaseConfig = {
            apiKey: "AIzaSyCVf3c_hHbZnBkapODJK13Tef57IAZoOkU",
            authDomain: "birgyfest.firebaseapp.com",
            projectId: "birgyfest",
            storageBucket: "birgyfest.firebasestorage.app",
            messagingSenderId: "748620159762",
            appId: "1:748620159762:web:0fb391badf84f5df35f1cb",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let isAuthReady = false;

        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if(user) { 
                isAuthReady = true; 
                // Si la URL ya trae el ID (porque se escaneó con otro app), verificamos directo
                const urlParams = new URLSearchParams(window.location.search);
                const guestId = urlParams.get('guestId');
                if(guestId) verifyGuest(guestId);
            }
        });

        // --- LÓGICA DE VERIFICACIÓN ---
        window.verifyGuest = async (guestId) => {
            if (!isAuthReady) return alert("Cargando sistema...");

            const statusBox = document.getElementById('status-box');
            const guestNameDisp = document.getElementById('guest-name-display');
            
            statusBox.className = "mt-6 p-6 rounded-2xl bg-gray-800 border border-gray-600 text-center animate-pulse";
            statusBox.innerHTML = "<p class='text-yellow-400 font-bold'>VERIFICANDO BASE DE DATOS...</p>";
            
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/birgyfest_guests`, guestId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    guestNameDisp.textContent = data.name;

                    if (data.has_entered) {
                        // YA ENTRÓ - ERROR
                        playSound('error');
                        statusBox.className = "mt-6 p-6 rounded-2xl bg-red-900/80 border-4 border-red-500 text-center";
                        statusBox.innerHTML = `
                            <h2 class="text-3xl font-black text-white title-font mb-2">¡ACCESO DENEGADO!</h2>
                            <p class="text-red-200 font-bold">CÓDIGO YA UTILIZADO</p>
                            <p class="text-sm text-red-300 mt-2">Este invitado ya ingresó previamente.</p>
                        `;
                    } else {
                        // NO HA ENTRADO - ÉXITO
                        // Marcamos como que ya entró
                        await updateDoc(docRef, { 
                            has_entered: true,
                            entry_time: new Date() 
                        });
                        
                        playSound('success');
                        statusBox.className = "mt-6 p-6 rounded-2xl bg-green-900/80 border-4 border-green-500 text-center";
                        statusBox.innerHTML = `
                            <h2 class="text-4xl font-black text-white title-font mb-2">¡ACCESO CONCEDIDO!</h2>
                            <p class="text-green-200 font-bold text-lg">BIENVENIDO/A</p>
                        `;
                    }
                } else {
                    // NO EXISTE EN LA BD
                    playSound('error');
                    guestNameDisp.textContent = "DESCONOCIDO";
                    statusBox.className = "mt-6 p-6 rounded-2xl bg-gray-800 border-4 border-red-500 text-center";
                    statusBox.innerHTML = `
                        <h2 class="text-3xl font-black text-red-500 title-font">INVITACIÓN FALSA</h2>
                        <p class="text-gray-400">Código no encontrado en el sistema.</p>
                    `;
                }
            } catch (error) {
                console.error(error);
                alert("Error de lectura. Revisa consola.");
            }
        };

        // Sonidos simples para feedback
        function playSound(type) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'success') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            } else {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            }
            
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        // --- CONFIGURACIÓN DEL ESCÁNER HTML5 ---
        window.startScanner = () => {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, 
                (decodedText, decodedResult) => {
                    // ÉXITO AL ESCANEAR
                    console.log(`Código escaneado = ${decodedText}`);
                    
                    // Detener cámara
                    html5QrCode.stop().then(() => {
                        // Extraer ID del URL: ...?guestId=XYZ
                        try {
                            const url = new URL(decodedText);
                            const id = url.searchParams.get("guestId");
                            if (id) {
                                verifyGuest(id);
                            } else {
                                alert("QR inválido: No es una invitación de BirgyFest");
                            }
                        } catch (e) {
                            // Si es solo el ID texto plano
                            verifyGuest(decodedText);
                        }
                    });
                },
                (errorMessage) => {
                    // Error de lectura (pasa muy rápido, mejor ignorar)
                }
            ).catch(err => {
                console.log(err);
                alert("Error al iniciar cámara. Asegúrate de dar permisos y usar HTTPS.");
            });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: white;
        }
        .title-font { font-family: 'Bebas Neue', cursive; }
        #reader {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 4px solid #3b82f6;
            background: black;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-6">

    <header class="w-full max-w-md text-center mb-8">
        <h1 class="title-font text-5xl text-white mb-2 tracking-widest">SEGURIDAD <span class="text-blue-500">BIRGYFEST</span></h1>
        <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Sistema de Control de Acceso</p>
    </header>

    <main class="w-full max-w-md space-y-6">
        
        <!-- Área de Cámara -->
        <div class="bg-gray-900 p-4 rounded-3xl shadow-2xl border border-gray-700">
            <div id="reader" class="h-64 bg-black mb-4 relative">
                <p class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-500 text-sm">
                    Cámara Inactiva
                </p>
            </div>
            <button onclick="startScanner()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg uppercase tracking-wider">
                ACTIVAR CÁMARA
            </button>
        </div>

        <!-- Tarjeta de Resultado -->
        <div id="status-box" class="hidden">
            <!-- Aquí se inyecta el resultado dinámicamente -->
        </div>

        <!-- Nombre del invitado escaneado -->
        <div class="text-center">
            <p class="text-gray-500 text-xs uppercase mb-1">Invitado Detectado</p>
            <h2 id="guest-name-display" class="text-2xl font-bold text-white">...</h2>
        </div>

    </main>

</body>
</html>