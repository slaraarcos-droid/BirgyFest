<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMIN SECURITY - BirgyFest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, getDocs, collection, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- TUS DATOS REALES ---
        const appId = 'birgyfest'; 
        const GUESTS_COLLECTION_PATH = `/artifacts/${appId}/public/data/birgyfest_guests`;

        const firebaseConfig = {
            apiKey: "AIzaSyCVf3c_hHbZnBkapODJK13Tef57IAZoOkU",
            authDomain: "birgyfest.firebaseapp.com",
            projectId: "birgyfest",
            storageBucket: "birgyfest.firebasestorage.app",
            messagingSenderId: "748620159762",
            appId: "1:748620159762:web:0fb391badf84f5df35f1cb",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let isAuthReady = false;
        let html5QrCode;

        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if(user) { 
                isAuthReady = true; 
                loadGuestList(); // Cargar lista al inicio
                
                // Si la URL trae ID, escanear directo
                const urlParams = new URLSearchParams(window.location.search);
                const guestId = urlParams.get('guestId');
                if(guestId) {
                    showScanner();
                    verifyGuest(guestId);
                }
            }
        });
        
        // --- VISTAS ---
        window.showScanner = () => {
            document.getElementById('scanner-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            
            // Actualizar botones de navegaci√≥n
            document.getElementById('btn-nav-scan').classList.add('bg-blue-600', 'text-white');
            document.getElementById('btn-nav-scan').classList.remove('bg-gray-800', 'text-gray-400');
            
            document.getElementById('btn-nav-list').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('btn-nav-list').classList.add('bg-gray-800', 'text-gray-400');
        };

        window.showAdminList = () => {
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            
            // Detener c√°mara si est√° activa
            if(html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.log("C√°mara detenida"));
            }

            // Actualizar botones de navegaci√≥n
            document.getElementById('btn-nav-list').classList.add('bg-blue-600', 'text-white');
            document.getElementById('btn-nav-list').classList.remove('bg-gray-800', 'text-gray-400');
            
            document.getElementById('btn-nav-scan').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('btn-nav-scan').classList.add('bg-gray-800', 'text-gray-400');
            
            loadGuestList();
        };

        // --- L√ìGICA DE ADMINISTRACI√ìN (EL CONTROL TOTAL) ---
        window.loadGuestList = async () => {
            if (!isAuthReady) return;

            const listContainer = document.getElementById('guest-list-container');
            listContainer.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto"></div></div>';

            try {
                const q = query(collection(db, GUESTS_COLLECTION_PATH), orderBy("name"));
                const querySnapshot = await getDocs(q);
                
                let htmlContent = '';
                let totalGuests = 0;
                let enteredGuests = 0;
                
                if (querySnapshot.empty) {
                    htmlContent = '<p class="text-center text-gray-500 py-8 italic">No hay invitados registrados.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        totalGuests++;
                        if(data.has_entered) enteredGuests++;

                        const statusBadge = data.has_entered 
                            ? '<span class="px-2 py-1 rounded text-[10px] font-bold bg-green-500/20 text-green-400 border border-green-500/50">ADENTRO</span>' 
                            : '<span class="px-2 py-1 rounded text-[10px] font-bold bg-yellow-500/20 text-yellow-400 border border-yellow-500/50">PENDIENTE</span>';
                        
                        htmlContent += `
                            <div class="glass-box p-3 rounded-xl flex items-center justify-between group">
                                <div>
                                    <p class="text-white font-bold text-sm">${data.name}</p>
                                    <div class="flex items-center gap-2 mt-1">
                                        ${statusBadge}
                                        <span class="text-[10px] text-gray-500 font-mono">${doc.id.substring(0,6)}...</span>
                                    </div>
                                </div>
                                <button onclick="deleteGuest('${doc.id}', '${data.name}')" 
                                        class="bg-red-500/10 hover:bg-red-600 hover:text-white text-red-500 border border-red-500/30 p-2 rounded-lg transition duration-300">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        `;
                    });
                }
                
                // Actualizar contadores
                document.getElementById('stats-total').innerText = totalGuests;
                document.getElementById('stats-entered').innerText = enteredGuests;
                
                listContainer.innerHTML = htmlContent;

            } catch (error) {
                console.error("Error:", error);
                listContainer.innerHTML = '<p class="text-center text-red-400 p-4">Error de conexi√≥n.</p>';
            }
        };

        // --- FUNCI√ìN DE ELIMINAR (SOLO PARA ADMIN) ---
        window.deleteGuest = async (guestId, guestName) => {
            if (!confirm(`‚ö†Ô∏è ¬øELIMINAR PASE?\n\nUsuario: ${guestName}\n\nSi lo eliminas, su QR dejar√° de funcionar inmediatamente.`)) return;
            
            try {
                const docRef = doc(db, GUESTS_COLLECTION_PATH, guestId);
                await deleteDoc(docRef);
                loadGuestList(); // Recargar lista
            } catch (error) {
                alert(`Error al eliminar: ${error.message}`);
            }
        };
        
        // --- SCANNER LOGIC ---
        window.verifyGuest = async (guestId) => {
            if (!isAuthReady) return;

            const statusBox = document.getElementById('status-box');
            
            document.getElementById('result-modal').classList.remove('hidden');
            statusBox.className = "p-6 rounded-2xl bg-gray-800 border border-gray-600 text-center animate-pulse";
            statusBox.innerHTML = "<p class='text-yellow-400 font-bold tracking-widest'>VERIFICANDO...</p>";
            
            try {
                const docRef = doc(db, GUESTS_COLLECTION_PATH, guestId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();

                    if (data.has_entered) {
                        playSound('error');
                        statusBox.className = "p-6 rounded-2xl bg-red-900/90 border-2 border-red-500 text-center shadow-[0_0_30px_rgba(239,68,68,0.4)]";
                        statusBox.innerHTML = `
                            <h2 class="text-3xl font-black text-white title-font mb-1 tracking-widest">‚ö†Ô∏è DENEGADO</h2>
                            <p class="text-white font-bold text-lg border-b border-white/20 pb-2 mb-2">${data.name}</p>
                            <p class="text-red-200 text-xs uppercase font-bold bg-red-950/50 py-1 rounded">ESTE PASE YA FUE USADO</p>
                        `;
                    } else {
                        await updateDoc(docRef, { has_entered: true, entry_time: new Date() });
                        playSound('success');
                        statusBox.className = "p-6 rounded-2xl bg-green-900/90 border-2 border-green-500 text-center shadow-[0_0_30px_rgba(34,197,94,0.4)]";
                        statusBox.innerHTML = `
                            <h2 class="text-4xl font-black text-white title-font mb-1 tracking-widest">‚úÖ APROBADO</h2>
                            <p class="text-white font-bold text-xl">${data.name}</p>
                            <p class="text-green-300 text-xs mt-2 uppercase tracking-wider">Bienvenido al BirgyFest</p>
                        `;
                    }
                } else {
                    playSound('error');
                    statusBox.className = "p-6 rounded-2xl bg-gray-900 border-2 border-red-500 text-center";
                    statusBox.innerHTML = `
                        <h2 class="text-3xl font-black text-red-500 title-font mb-2">‚ùå NO EXISTE</h2>
                        <p class="text-gray-400 text-sm">C√≥digo no encontrado en base de datos.</p>
                    `;
                }
            } catch (error) {
                console.error(error);
                statusBox.innerHTML = "<p class='text-red-500'>Error de lectura.</p>";
            }
        };

        window.closeModal = () => {
            document.getElementById('result-modal').classList.add('hidden');
            // Si el esc√°ner estaba corriendo, sigue corriendo
        };

        function playSound(type) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'success') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            } else {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            }
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        window.startScanner = () => {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            document.getElementById('camera-placeholder').classList.add('hidden');
            
            html5QrCode.start({ facingMode: "environment" }, config, 
                (decodedText) => {
                    try {
                        const url = new URL(decodedText);
                        const id = url.searchParams.get("guestId");
                        verifyGuest(id || decodedText);
                    } catch (e) {
                        verifyGuest(decodedText);
                    }
                },
                () => {}
            ).catch(err => alert("Error c√°mara: " + err));
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap');
        
        /* üí° SOLUCI√ìN DEFINITIVA PARA LA ALTURA EN M√ìVILES (VH): */
        html, body {
            /* Usa 100% en lugar de 100vh para mejor compatibilidad con barras m√≥viles */
            height: 100%; 
            overflow-y: hidden; /* Evita el scroll del body */
        }
        
        /* Definir altura en main, usando flexbox para distribuir el contenido */
        #main-content {
            height: 100%; /* Ocupa el 100% de la altura de body */
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #030712; 
            color: white; 
        }

        .title-font { font-family: 'Bebas Neue', cursive; }
        .glass-box { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-panel { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); }
        #reader video { border-radius: 12px; object-fit: cover; }
        
        /* Ajuste para scrollbar en la lista */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(71, 85, 105, 0.5); /* gray-600/50 */
            border-radius: 2px;
        }

        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(71, 85, 105, 0.5) transparent; 
        }
    </style>
</head>
<body class="bg-[url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=1920')] bg-cover bg-center">
    
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>

    <main id="main-content" class="relative z-10 w-full max-w-md mx-auto flex flex-col p-4">
        
        <header class="text-center py-4">
            <h1 class="title-font text-4xl text-white tracking-widest">BIRGY<span class="text-blue-500">SEC</span></h1>
            <p class="text-gray-500 text-[10px] font-bold uppercase tracking-[0.3em]">ADMIN CONTROL PANEL</p>
        </header>

        <div class="flex bg-gray-900 p-1 rounded-xl mb-6 border border-gray-800">
            <button onclick="showScanner()" id="btn-nav-scan" class="flex-1 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white transition-all">
                ESC√ÅNER QR
            </button>
            <button onclick="showAdminList()" id="btn-nav-list" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-400 transition-all hover:text-white">
                LISTA INVITADOS
            </button>
        </div>

        <div id="scanner-view" class="flex-1 flex flex-col">
            <div class="glass-panel p-4 rounded-3xl border border-gray-700 shadow-2xl flex-1 flex flex-col">
                <div class="relative flex-1 bg-black rounded-2xl overflow-hidden border-2 border-blue-500/50 mb-4 flex items-center justify-center">
                    <div id="reader" class="w-full h-full"></div>
                    <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                        <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="text-xs uppercase tracking-widest font-bold">C√°mara en espera</span>
                    </div>
                </div>
                <button onclick="startScanner()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg uppercase tracking-wider flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    ACTIVAR L√ÅSER
                </button>
            </div>
        </div>

        <div id="admin-view" class="hidden flex-1 flex flex-col min-h-0">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="glass-box p-3 rounded-xl border-l-4 border-l-blue-500">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider">Total Invitados</p>
                    <p class="text-2xl font-black text-white title-font" id="stats-total">0</p>
                </div>
                <div class="glass-box p-3 rounded-xl border-l-4 border-l-green-500">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider">Ya Ingresaron</p>
                    <p class="text-2xl font-black text-white title-font" id="stats-entered">0</p>
                </div>
            </div>

            <div class="glass-panel p-3 sm:p-4 rounded-3xl border border-gray-700 shadow-2xl flex-1 flex flex-col min-h-0">
                <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                    <h3 class="text-xl font-bold text-white title-font tracking-wide">REGISTRO DE USUARIOS</h3>
                    <button onclick="loadGuestList()" class="text-xs bg-gray-800 hover:bg-gray-700 p-2 rounded-lg text-white transition">
                        ‚Üª
                    </button>
                </div>
                
                <div class="overflow-y-auto flex-1 pr-1 custom-scrollbar space-y-2" id="guest-list-container">
                    </div>
            </div>
        </div>

    </main>

    <div id="result-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-6">
        <div class="w-full max-w-sm" id="status-box">
            </div>
        <button onclick="closeModal()" class="absolute top-6 right-6 text-white/50 hover:text-white">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

</body>
</html>